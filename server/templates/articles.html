{{template "base.html" .}}

{{define "title"}}Articles - Newscope{{end}}

{{define "content"}}
<div class="articles-header">
    <h2>Articles <span id="article-count" class="article-count">({{.ArticleCount}})</span></h2>
    
    <!-- Score filter -->
    <div class="filters">
        <label for="score-filter">Min Score:</label>
        <input type="range" id="score-filter" name="score" min="0" max="10" value="{{.MinScore}}" step="0.5"
               hx-get="/articles"
               hx-trigger="change"
               hx-target="#articles-container"
               hx-include="#topic-filter, #feed-filter, #sort-filter">
        <span id="score-value">{{.MinScore}}</span>
        
        <!-- Topic filter -->
        <label for="topic-filter">Topic:</label>
        <select id="topic-filter" name="topic"
                hx-get="/articles"
                hx-trigger="change"
                hx-target="#articles-container"
                hx-include="#score-filter, #feed-filter, #sort-filter">
            <option value="">All Topics</option>
            {{range .Topics}}
            <option value="{{.}}" {{if eq $.SelectedTopic .}}selected{{end}}>{{.}}</option>
            {{end}}
        </select>
        
        <!-- Feed filter -->
        <label for="feed-filter">Feed:</label>
        <select id="feed-filter" name="feed"
                hx-get="/articles"
                hx-trigger="change"
                hx-target="#articles-container"
                hx-include="#score-filter, #topic-filter, #sort-filter">
            <option value="">All Feeds</option>
            {{range .Feeds}}
            <option value="{{.}}" {{if eq $.SelectedFeed .}}selected{{end}}>{{.}}</option>
            {{end}}
        </select>
        
        <!-- Sort filter -->
        <label for="sort-filter">Sort:</label>
        <select id="sort-filter" name="sort"
                hx-get="/articles"
                hx-trigger="change"
                hx-target="#articles-container"
                hx-include="#score-filter, #topic-filter, #feed-filter, #sort-filter">
            <option value="published" {{if eq .SelectedSort "published"}}selected{{end}}>Date</option>
            <option value="score" {{if eq .SelectedSort "score"}}selected{{end}}>Score</option>
            <option value="source+date" {{if eq .SelectedSort "source+date"}}selected{{end}}>Source + Date</option>
            <option value="source+score" {{if eq .SelectedSort "source+score"}}selected{{end}}>Source + Score</option>
        </select>
        
        <!-- View mode toggle -->
        <label>View:</label>
        <div class="view-toggle-buttons">
            <button id="view-expanded" class="btn-view-toggle active" title="Expanded view">⊞</button>
            <button id="view-condensed" class="btn-view-toggle" title="Condensed view">☰</button>
        </div>
    </div>
</div>

<div id="articles-container" class="view-expanded">
    <div id="articles-list">
        {{range .Articles}}
        {{template "article-card.html" .}}
        {{else}}
        <p class="no-articles">No articles found. Try lowering the score filter or wait for classification to run.</p>
        {{end}}
    </div>
</div>

<!-- Auto-update score display and localStorage -->
<script>
// Load saved preferences from localStorage
document.addEventListener('DOMContentLoaded', function() {
    // Load saved min score
    const savedScore = localStorage.getItem('newscopeMinScore');
    if (savedScore !== null && savedScore !== '{{.MinScore}}') {
        // If saved score differs from server default, navigate to it
        const scoreFilter = document.getElementById('score-filter');
        scoreFilter.value = savedScore;
        document.getElementById('score-value').textContent = savedScore;
        
        // Trigger HTMX request to load articles with saved score
        htmx.trigger(scoreFilter, 'change');
    }
    
    // Load saved view mode
    const savedView = localStorage.getItem('newscopeViewMode') || 'expanded';
    setViewMode(savedView);
    
    // Load saved sort preference
    const savedSort = localStorage.getItem('newscopeSortBy');
    if (savedSort !== null && savedSort !== '{{.SelectedSort}}') {
        // If saved sort differs from server default, navigate to it
        const sortFilter = document.getElementById('sort-filter');
        sortFilter.value = savedSort;
        
        // Trigger HTMX request to load articles with saved sort
        htmx.trigger(sortFilter, 'change');
    }
});

// Update score display and save to localStorage
document.getElementById('score-filter').addEventListener('input', function(e) {
    const value = e.target.value;
    document.getElementById('score-value').textContent = value;
    // Save to localStorage
    localStorage.setItem('newscopeMinScore', value);
});

// Also save when change event fires (for programmatic changes)
document.getElementById('score-filter').addEventListener('change', function(e) {
    localStorage.setItem('newscopeMinScore', e.target.value);
});

// View mode functionality
function setViewMode(mode) {
    const container = document.getElementById('articles-container');
    const expandedBtn = document.getElementById('view-expanded');
    const condensedBtn = document.getElementById('view-condensed');
    
    // Update container class
    container.className = 'view-' + mode;
    
    // Update button states
    if (mode === 'expanded') {
        expandedBtn.classList.add('active');
        condensedBtn.classList.remove('active');
    } else {
        expandedBtn.classList.remove('active');
        condensedBtn.classList.add('active');
    }
    
    // Save to localStorage
    localStorage.setItem('newscopeViewMode', mode);
}

// View mode toggle handlers
document.getElementById('view-expanded').addEventListener('click', function() {
    setViewMode('expanded');
});

document.getElementById('view-condensed').addEventListener('click', function() {
    setViewMode('condensed');
});

// Sort preference persistence
document.getElementById('sort-filter').addEventListener('change', function(e) {
    localStorage.setItem('newscopeSortBy', e.target.value);
});
</script>
{{end}}